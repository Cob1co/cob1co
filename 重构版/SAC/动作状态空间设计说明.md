# 第二阶段：动作空间与状态空间设计说明

## 一、与开源代码的对比

### 1.1 开源代码（微燃机+电池系统）

**动作空间（6维）**：
```
[0] MT1出力：微燃机1功率 ∈ [0, 20] MW
[1] MT2出力：微燃机2功率 ∈ [0, 40] MW
[2] MT3出力：微燃机3功率 ∈ [0, 40] MW
[3] MT4出力：微燃机4功率 ∈ [0, 50] MW
[4] ESS1充放：电池1充放电 ∈ [-16.6, 17.9] MW
[5] ESS2充放：电池2充放电 ∈ [-27.6, 36.1] MW
```

**状态空间（6维）**：
```
[0] load：负荷
[1] pv：光伏出力
[2] wind：风电出力
[3] soc_1：电池1的SOC
[4] soc_2：电池2的SOC
[5] price：电价
```

---

### 1.2 我们的系统（风光+熔盐储热系统）

**动作空间（1维）** ✅：
```
[0] 储能充放指令 ∈ [-1, 1]
    > 0: 充电模式（启动电加热器，吸收多余可再生能源）
    < 0: 放电模式（启动汽轮机，补充电力不足）
    = 0: 待机模式（储能不工作）
```

**为什么是1维而不是6维？**
- ❌ **风电出力**：不可控，由天气决定（是状态，不是动作）
- ❌ **光伏出力**：不可控，由天气决定（是状态，不是动作）
- ✅ **熔盐储能**：可控，是唯一的决策变量
- ❌ **电网购售**：自动平衡的结果，不是独立决策
  ```
  p_grid = (风+光+汽轮机放电) - (负荷+电加热器充电)
  ```

**状态空间（6维）** ✅：
```
[0] load_mw/max_load：负荷（归一化）
[1] pv_mw/max_pv：光伏出力（归一化）
[2] wind_mw/max_wind：风电出力（归一化）
[3] soc：储能SOC（0-1）
[4] price/max_price：电价（归一化）
[5] p_grid_prev/max_grid：上时刻电网功率（归一化）
```

---

## 二、动作空间的物理映射

### 2.1 从归一化动作到实际功率

```python
def action_to_power(action, soc, capacity_eh, capacity_st, eta_eh, eta_st, dt):
    """
    将归一化动作 [-1, 1] 转换为实际充放电功率
    
    参数：
        action: 强化学习输出的动作 ∈ [-1, 1]
        soc: 当前储能SOC
        capacity_eh: 电加热器额定功率 (MW_th)
        capacity_st: 汽轮机额定功率 (MW_e)
        eta_eh: 电加热器效率
        eta_st: 汽轮机效率
        dt: 时间步长（小时）
    
    返回：
        p_eh_in: 电加热器实际电功率输入 (MW)
        p_st_out: 汽轮机实际电功率输出 (MW)
    """
    
    if action > 0:  # 充电模式
        # 计算最大可充电功率（受SOC上限约束）
        max_charge_energy = (SOC_MAX - soc) * capacity_ts  # MWh_th
        max_charge_power_th = max_charge_energy / dt  # MW_th
        max_charge_power_elec = max_charge_power_th / eta_eh  # MW_e
        
        # 实际充电功率
        p_eh_in = action * min(max_charge_power_elec, capacity_eh / eta_eh)
        p_st_out = 0.0
        
    elif action < 0:  # 放电模式
        # 计算最大可放电功率（受SOC下限约束）
        max_discharge_energy = (soc - SOC_MIN) * capacity_ts  # MWh_th
        max_discharge_power_th = max_discharge_energy / dt  # MW_th
        max_discharge_power_elec = max_discharge_power_th * eta_st  # MW_e
        
        # 实际放电功率
        p_st_out = abs(action) * min(max_discharge_power_elec, capacity_st)
        p_eh_in = 0.0
        
    else:  # 待机模式
        p_eh_in = 0.0
        p_st_out = 0.0
    
    return p_eh_in, p_st_out
```

---

## 三、电网功率平衡逻辑

### 3.1 能量流图

```
可再生发电：
┌─────────┐     ┌─────────┐
│ 风力发电 │────►│         │
└─────────┘     │         │
                │  电网   │◄────►  外部电网
┌─────────┐     │  汇流   │        (p_grid)
│ 光伏发电 │────►│  母线   │
└─────────┘     │         │
                └────┬────┘
                     │
          ┌──────────┴──────────┐
          │                     │
     ┌────▼────┐           ┌───▼────┐
     │   负荷   │           │ 储能系统│
     └─────────┘           └────────┘
                           ▲    │
                           │    │
                      充电 │    │ 放电
                   (电加热器)  (汽轮机)
```

### 3.2 功率平衡公式

```python
# 供给侧
p_supply = p_wind + p_pv + p_st_out

# 需求侧
p_demand = p_load + p_eh_in

# 电网交互（自动平衡）
p_grid = p_supply - p_demand

if p_grid > 0:
    # 向电网售电（可再生过剩）
    revenue = p_grid * price * 1000  # 元/h
    cost = 0
elif p_grid < 0:
    # 从电网购电（可再生不足）
    revenue = 0
    cost = abs(p_grid) * price * 1000  # 元/h
else:
    # 自平衡
    revenue = 0
    cost = 0
```

---

## 四、状态空间的作用

| 状态维度 | 作用 | 为什么需要 |
|---------|------|-----------|
| **负荷** | 知道当前需求 | 决策基础：需要多少电 |
| **光伏** | 知道当前供给 | 判断是否有多余电可充储能 |
| **风电** | 知道当前供给 | 判断是否有多余电可充储能 |
| **SOC** | 知道储能状态 | 约束决策：还能充多少/放多少 |
| **电价** | 知道电价信号 | 经济优化：低价充电，高价放电 |
| **上时刻电网功率** | 知道历史状态 | 平滑波动：避免电网功率剧烈变化 |

---

## 五、为什么这个设计是简洁且充分的？

### ✅ 简洁性
1. **动作1维**：只需决策储能充放，无需考虑多个设备协调
2. **状态6维**：包含所有必要信息，无冗余
3. **自动平衡**：电网功率不需要显式决策，物理自动平衡

### ✅ 充分性
1. **包含所有可控因素**：储能是唯一可控设备
2. **包含所有关键信息**：供需、价格、约束、历史
3. **符合物理规律**：功率平衡自动满足

### ✅ 与开源代码的实质等价性

| 特征 | 开源代码 | 我们的设计 | 等价性 |
|-----|---------|-----------|--------|
| **可控设备** | 4个微燃机+2个电池 | 1个储能（充+放） | ✅ 都是可调度资源 |
| **不可控输入** | 光伏+风电+负荷 | 光伏+风电+负荷 | ✅ 完全相同 |
| **优化目标** | 成本+自平衡 | 成本+波动 | ✅ 实质相同 |
| **状态维度** | 6维 | 6维 | ✅ 复杂度相同 |
| **决策复杂度** | 6维连续 | 1维连续 | ✅ 我们更简单！ |

---

## 六、总结

我们的设计：
- **动作1维**：比开源的6维**更简单**
- **状态6维**：与开源代码**复杂度相同**
- **物理建模**：更符合实际系统（电网被动平衡）
- **训练效率**：更快（低维动作空间）
- **实用性**：更强（无需多设备协调）

这个设计既保留了问题的本质复杂度，又避免了不必要的高维决策空间。✅
