# Phase 3：学习型 MPC 总体思路说明

## 1. 目标与定位

- 在 **已有两阶段结果** 基础上，引入第三阶段：
  - Phase1：容量配置（风光+储热+电加热+汽轮机），已经固定。
  - Phase2：5 个 SAC 专家，给出“典型天气下”的 **小时级参考策略**。
- Phase3 的任务：
  - 在 **15 分钟级** 时序上，结合专家参考计划和带误差的预测数据，
  - 用 MPC 做实时优化，
  - 再用 Transformer 学习“在不同工况下如何调节 MPC 目标函数的权重”。

一句话：**在专家策略之上，加一层学习型权重控制，让 MPC 更聪明地折中“跟专家 vs 降成本 vs 减波动”。**

---

## 2. 三层控制架构（概念）

从长到短，三层：

1. **战略层（96h / 多天）**  
   - 由 Phase2 的 5 个 SAC 专家构成。  
   - 输入：24h / 多天的风光负荷预测。  
   - 输出：每种天气类型下的 **小时级参考计划**（SOC 轨迹 + 电网功率大趋势）。

2. **战术层（6h）——Transformer 权重控制器**  
   - 输入：过去 6 小时的系统状态和预测质量（24 步 × 12 维）。  
   - 输出：下一小时左右 MPC 的 **三组动态权重**：
     - `α_soc`：SOC 跟踪参考计划的权重  
     - `α_grid`：电网功率跟踪参考计划的权重  
     - `α_cost`：运行成本的权重

3. **执行层（15min）——MPC 实时控制**  
   - 时间步长 15 分钟。  
   - 每步：
     - 接收未来 4–8 小时预测（带误差）；  
     - 接收专家给的 8 小时参考轨迹；  
     - 接收 Transformer 输出的 `α_*`；  
     - 解一个凸优化问题，给出当前 15 分钟的储能充放电动作。

---

## 3. 数据使用与时间线

- **训练期（离线，2023 年）**：
  - 实际历史数据：`data/data2023.csv`（1h 分辨率）  
  - 预测数据：`LMPC/data/forecast_2023_8h_training.pkl`  
  - 用这些数据：
    - 让“专家 + MPC”在 2023 年上跑仿真；  
    - 通过 H 步前瞻 + 网格搜索，找到每个时刻的最优 `(α_soc, α_grid, α_cost)`；  
    - 形成 Transformer 的训练集。

- **在线期 / 测试期（2024 年）**：
  - 真实“实时”数据：`data/realtime2024.csv` 或 `generate_realtime_2024.py` 生成的 15min 序列  
  - 预测数据：`LMPC/data/forecast_2024_8h_testing.pkl`  
  - 每 15min：
    - 天气分类 → 选专家 → 生成参考轨迹；  
    - 提取 6h 历史特征 → Transformer 输出动态权重；  
    - MPC 用动态权重求解最优动作，和真实 2024 数据一起仿真评估。

---

## 4. 学习逻辑

- **标签（监督信号）从哪来？**  
  - 没有“真实系统告诉 α”的 ground truth，只能“在真实数据上的理想 MPC”中，通过 H 步前瞻 + 网格搜索推出来：
    - 定义统一的 MPC 目标函数 J（包含 soc 跟踪、grid 跟踪、成本、ramp 等）；  
    - 在所有候选 `(α_soc, α_grid, α_cost)` 中选 J 最小的一组作为标签。

- **Transformer 学什么？**  
  - 给定当前过去 6h 状态（SOC 偏差、预测误差、时段、专家切换信息等），  
  - 直接回归对应时刻的最优 `(α_soc, α_grid, α_cost)`。  
  - 相当于学了一个“condition → best weights”的映射，从而在线时不需要再做网格搜索。

---

## 5. 评价指标与基线

- 不仅看“是否比 Phase2 专家好”，而是有多层基线：
  1. 只用专家策略（不加 MPC）；
  2. 专家 + 固定权重 MPC（α≡1.0）；
  3. 专家 + Transformer 动态权重 MPC（完整 Phase3）。

- 关键指标：
  - 总运行成本；  
  - SOC 跟踪 RMSE（相对专家计划）；  
  - 电网功率跟踪 RMSE；  
  - 约束违反率；  
  - 权重变化的平滑性（标准差）。

---
